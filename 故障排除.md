# 故障排除指南

## 當前狀態

你遇到的問題：**無法儲存設定**

## 診斷步驟

### 1. 確認應用程式正在運行

```bash
# 啟動開發模式
npm run dev
```

應該會看到：
- Vite 開發伺服器啟動（port 5174）
- Electron 應用程式視窗開啟
- 開發者工具自動開啟

### 2. 檢查 ElectronAPI 是否可用

在開發者工具的 Console 中輸入：

```javascript
// 檢查 API 是否存在
console.log('electronAPI:', window.electronAPI);
console.log('API methods:', Object.keys(window.electronAPI));
```

**預期結果：**
```javascript
electronAPI: {
  transcribeAudio: ƒ,
  saveSettings: ƒ,
  loadSettings: ƒ,
  copyToClipboard: ƒ,
  ...
}
```

**如果顯示 `undefined`：**
- preload 腳本沒有正確載入
- 需要檢查 WindowManager 的 preload 路徑

### 3. 測試載入設定

在 Console 中輸入：

```javascript
// 測試載入設定
window.electronAPI.loadSettings()
  .then(settings => console.log('Settings:', settings))
  .catch(error => console.error('Error:', error));
```

**預期結果：**
```javascript
Settings: {
  apiKey: "",
  defaultLanguage: "zh",
  shortcuts: {...},
  windowOpacity: 0.95,
  historyLimit: 50
}
```

### 4. 測試儲存設定

在 Console 中輸入：

```javascript
// 測試儲存設定
const testSettings = {
  apiKey: "sk-test1234567890123456789",
  defaultLanguage: "zh",
  shortcuts: {
    startRecording: "CommandOrControl+Shift+R",
    stopRecording: "CommandOrControl+Shift+S"
  },
  windowOpacity: 0.95,
  historyLimit: 50
};

window.electronAPI.saveSettings(testSettings)
  .then(() => console.log('✓ Save successful'))
  .catch(error => console.error('✗ Save failed:', error));
```

### 5. 驗證設定已儲存

```javascript
// 重新載入設定
window.electronAPI.loadSettings()
  .then(settings => {
    console.log('Loaded settings:', settings);
    if (settings.apiKey) {
      console.log('✓ API key was saved');
    } else {
      console.log('✗ API key was NOT saved');
    }
  });
```

### 6. 檢查設定檔

在終端機執行：

```bash
# 列出所有設定檔
ls -la ~/Library/Application\ Support/voice-input-app/*.json

# 查看設定內容
cat ~/Library/Application\ Support/voice-input-app/app-settings.json
```

## 常見問題和解決方法

### 問題 1：electronAPI is undefined

**原因：** preload 腳本沒有載入

**解決方法：**

1. 檢查 `dist/main/main/preload.js` 是否存在：
   ```bash
   ls -la dist/main/main/preload.js
   ```

2. 如果不存在，重新建置：
   ```bash
   npm run build:main
   ```

3. 檢查 WindowManager.ts 中的 preload 路徑：
   ```typescript
   preload: path.join(__dirname, '../main/preload.js')
   ```

### 問題 2：Save settings 沒有錯誤但設定沒有儲存

**原因：** IPC 通訊可能有問題

**解決方法：**

1. 在 `src/main/IPCHandler.ts` 的 `handleSaveSettings` 加入日誌：
   ```typescript
   async handleSaveSettings(settings: AppSettings): Promise<void> {
     console.log('Saving settings:', settings);
     try {
       this.settingsManager.save(settings);
       console.log('Settings saved successfully');
     } catch (error) {
       console.error('Failed to save settings:', error);
       throw error;
     }
   }
   ```

2. 重新建置並啟動：
   ```bash
   npm run build:main
   npm run dev
   ```

3. 查看終端機的日誌輸出

### 問題 3：API 金鑰驗證失敗

**原因：** 驗證規則太嚴格

**臨時解決方法：**

在 Console 中使用更長的測試金鑰：

```javascript
const testSettings = {
  apiKey: "sk-proj-1234567890123456789012345678901234567890",  // 至少 20 字元
  defaultLanguage: "zh",
  shortcuts: {
    startRecording: "CommandOrControl+Shift+R",
    stopRecording: "CommandOrControl+Shift+S"
  },
  windowOpacity: 0.95,
  historyLimit: 50
};

window.electronAPI.saveSettings(testSettings);
```

### 問題 4：設定視窗無法關閉

**原因：** 驗證錯誤阻止了儲存

**解決方法：**

1. 檢查所有欄位是否符合要求：
   - API 金鑰：以 `sk-` 開頭，至少 20 字元
   - 快捷鍵：不能相同
   - 透明度：50-100%
   - 歷史限制：1-100

2. 查看設定視窗中的錯誤訊息（紅色文字）

3. 如果沒有錯誤訊息但仍無法儲存，檢查 Console 的錯誤

## 完整測試流程

### 方法 1：使用 Console

```javascript
// 1. 檢查 API
console.log('API available:', !!window.electronAPI);

// 2. 載入預設設定
const settings = await window.electronAPI.loadSettings();
console.log('Default settings:', settings);

// 3. 修改並儲存
settings.apiKey = "sk-test12345678901234567890";
await window.electronAPI.saveSettings(settings);
console.log('Settings saved');

// 4. 驗證
const newSettings = await window.electronAPI.loadSettings();
console.log('Verified:', newSettings.apiKey === "sk-test12345678901234567890");
```

### 方法 2：使用除錯頁面

1. 確保 `npm run dev` 正在運行
2. 在瀏覽器開啟：`http://localhost:5174/debug-settings.html`
3. 依序點擊測試按鈕：
   - Check API
   - Load Settings
   - Save Settings（輸入測試金鑰）
   - Test Full Flow

## 重置和重新開始

如果所有方法都失敗，完全重置：

```bash
# 1. 停止所有進程
# 按 Ctrl+C

# 2. 清除所有資料
rm -rf ~/Library/Application\ Support/voice-input-app/
rm -rf dist/
rm -rf node_modules/.vite/

# 3. 重新安裝（如果需要）
npm install

# 4. 重新建置
npm run build

# 5. 啟動
npm run dev
```

## 檢查清單

在報告問題前，請確認：

- [ ] `npm run dev` 成功啟動
- [ ] 應用程式視窗已開啟
- [ ] 開發者工具已開啟
- [ ] Console 中 `window.electronAPI` 不是 undefined
- [ ] 可以執行 `window.electronAPI.loadSettings()`
- [ ] API 金鑰格式正確（sk- 開頭，至少 20 字元）
- [ ] 沒有其他驗證錯誤
- [ ] 查看了 Console 和終端機的所有錯誤訊息

## 需要更多幫助？

如果問題仍然存在，請提供：

1. **Console 輸出**
   ```javascript
   // 在 Console 執行並複製結果
   console.log('API:', !!window.electronAPI);
   window.electronAPI.loadSettings().then(console.log).catch(console.error);
   ```

2. **終端機輸出**
   - 複製 `npm run dev` 的完整輸出

3. **系統資訊**
   ```bash
   sw_vers  # macOS 版本
   node --version  # Node.js 版本
   npm --version  # npm 版本
   ```

4. **錯誤截圖**
   - 設定視窗的錯誤訊息
   - Console 的錯誤訊息

將這些資訊提供給開發者，可以更快地解決問題。
